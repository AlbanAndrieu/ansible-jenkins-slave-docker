#see https://blog.trifork.com/2013/04/02/ansible-example-playbook-to-setup-jenkins-slave/

#for testing purpose
#sudo ansible-playbook -i hosts -c local -v jenkins-slave.yml -vvvv

- hosts: all
  gather_facts: true
  tasks:
    - name: group hosts by distribution
      group_by: key="{{ ansible_distribution }}-{{ ansible_distribution_version }}"

- hosts: RedHat-7*:RedHat-6*:CentOS-7*:CentOS-6*:Ubuntu-17*:Ubuntu-16*:Ubuntu-15*:Ubuntu-13*:Ubuntu-14*:Ubuntu-12*
  gather_facts: false
  tasks:
    - name: group hosts for supported distributions
      group_by: key="supported"

- hosts: "!supported"
  gather_facts: false
  tasks:
    - name: fail for unsupported distribution
      fail: msg="{{ ansible_distribution }} {{ ansible_distribution_version }}
                 is not a supported OS for a Tower installation.  Supported
                 OSes include Red Hat Enterprise Linux 6/7, CentOS 6/7, or
                 Ubuntu 12.04/12.04/14.04/16.04/17.04."
    - debug: msg="Version {{ ansible_distribution }} {{ ansible_distribution_version }} {{ ansible_architecture }}"

#as root
#ansible-playbook jenkins-slave.yml -i hosts -vvvv
#as albandri
#ansible-playbook jenkins-slave.yml -i hosts -vvvv --ask-sudo-pass --sudo
# --extra-vars "jenkins_username=aandrieu jenkins_password=tbd"

#- name: Apply hostname configuration
#  hosts: all
#  remote_user: root
##  connection: local
#
#  roles:
#    - hostname

#- name: Install git
#  hosts: all
#  become: true
#  remote_user: root
##  connection: local
#
#  roles:
#    - role: geerlingguy.git
#
#- name: Install subversion
#  hosts: all
#  remote_user: root
##  connection: local
#
#  roles:
#    - role: alban.andrieu.subversion
#
#  vars:
#      subversion_rabbitvcs_enabled: no
#      subversion_diff_enabled: no

- name: Apply common configuration to all jenkins slaves
  hosts: all
  become: yes
  remote_user: root

  roles:
    - { role: alban.andrieu.jenkins-slave,
        docker_files_enable: yes,
        docker_files_generated_directory: "./",
        shell_git_machine: 82.231.208.223,
        shell_git_login: jenkins,
        shell_git_password: microsoft,
        shell_git_email: "alban.andrieu@free.fr",
        subversion_rabbitvcs_enabled: no,
        subversion_diff_enabled: no,
        # tomcat_started_check_enable: yes does not work on docker hub
        tomcat_started_check_enable: no,
        #jenkins_jdk7_enable: yes,
        jenkins_ssh_key_file: "",
        gcc_version: "4:4.8.2-1ubuntu6",
        cppunit_version: "1.13-0",
        boost_version: "1.54",
      }

#  vars:
#    jenkins_home: "/jenkins"
#    jenkins_slave_home: "/kgr-mvn"

#- name: Apply swarm configuration to all jenkins slaves
#  hosts: all
#  sudo: yes
#  remote_user: vagrant
#  connection: local
##  remote_user: vagrant
#
#  vars_prompt:
#  - name: jenkins_username
#    prompt: "What is your jenkins user?"
#    private: no
#  - name: jenkins_password
#    prompt: "What is your jenkins password?"
#    private: yes
#
#  roles:
#    - alban.andrieu.jenkins-swarm
#
#  vars:
#    jenkins_home: "/jenkins"

#- name: Install xvbf
#  hosts: all
#  become: true
#  remote_user: root
##  connection: local
#
#  roles:
#    - alban.andrieu.xvbf
#
##Below cmake role is included in cpp role
##- name: Install cmake
##  hosts: all
##  remote_user: root
###  connection: local
##
##  roles:
##    - alban.andrieu.cmake
#
#- name: Install cpp
#  hosts: all
#  remote_user: root
##  connection: local
#
#  roles:
#    - alban.andrieu.cpp
#
#  vars:
#      gcc_version: "4:4.8.2-1ubuntu6"
#      cppunit_version: "1.13-0"
#      boost_version: "1.54"

